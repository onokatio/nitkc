実験実習 ライントレーサー実験 レポート
===

# 1. 目的

H8マイコンを用いて、白線を走行するライントレーサーを作成する

# 2. 担当コース

全部（弊チームは、コースごとに担当を分けず、すべてのコースに対応できるプログラムを全員で実装・設計した。）

# 3. 制御アルゴリズムについて

弊チームのライントレーサーは、主に２つの制御アルゴリズムを搭載している。
一つは、「白線を追いかける」ためのもの。もう一つは「白線を飛び越える」ためのものである。

また白線を飛び越えるアルゴリズムでは、内部的に白線が途切れた検知のアルゴリズムを用いている。
また、白線と黒い台紙の識別に平均値を使ったアルゴリズムを用いている。
それらについても特筆する。

### - 白線を追いかけるアルゴリズム
白線を検知し続ける限り直進するが、白線から外れかけたり、外れたりした場合に自身の姿勢を修正し白線へ復帰するアルゴリズムである。

このアルゴリズムでは、最後に白線を検知したセンサーが右か左かを覚えておき、右なら自分の右に、左なら自分の左に白線があると認知する。
白線が両方のセンサーから検出されている場合は、左右両モーターを最大速度で動作させる。
片方から白線を検出、または両方共白線を見失った場合にはこのアルゴリズムを使用し、白線がある方向へ車体を移動させる。つまりどちらか片方の車輪の速度を落としている。

この制御にはPID制御でいうところのP制御を用いている。
白線から離れている時間=距離とし、距離が遠ければ遠いほど曲がる角度が激しくなっていくように動作する。このため、ささいな外れやカーブには少しの修正を、大きなカーブには大きな修正を適用した。

### - 白線を飛び越えるアルゴリズム
このアルゴリズムは、白線が途切れた場合に使用し、事前に設定したとおり線が見つかるまで直進や、左旋回、右旋回を実行する。
また、白線から外れたのではなく白線が途切れたことを検知するようになっている。

このとき、左旋回と右旋回は、両方の車輪を逆転させその場で旋回するようにした。理由は、そのほうが速いからである。

### - 白線が途切れる検知をしたアルゴリズム
白線から外れたのではなく途切れたことを検知するために、リングバッファを用いた。
今センサーが「白線の上にいるか」「黒い台紙の上にいるか」を順に配列に保管していき、最高10msまでさかのぼって過去のセンサーの状態を取得できるような実装を行った。

そのため、白線を見失った場合に過去のセンサー値をさかのぼり、左右のセンサー両方共白だった期間が5ms以上の間あったかどうかを判別している。
つまり、このアルゴリズムは、線が途切れる前は白線が必ず直線なことを逆手に取っている。
過去5msに渡り白線が安定して検出され続けていた、ということは、すなわちカーブしていなかったのにもかかわらず一回の割り込みをまたいでいきなり白線を両方のセンサーで見失った、ということになる。
その手法を用いて、カーブの途中ではなく白線の切れ目を判定した。

### - 白線、黒い台紙の識別アルゴリズム

左右の白線の値の平均と、左右の黒い台紙の値の平均で平均を取り、その値より上か下かで白線か黒い台紙かを判別した。

また、白線の蛍光灯の明るさや時間帯によって周囲の明るさ環境が異なるため、白線や黒い台紙を検出する値を毎回コンパイルせずに設定できるようにした。設定方法は後術するメニューから行える。

## その他

アルゴリズムには直接は関係ないものの、その調整や設定が楽になるよう、様々な機能を追加した。

### メニュー機能
白ボタンに項目移動、茶色ボタンに決定の役割をもたせ、メニューを作成した。

以下、項目を説明する。

- SET KP: 決定ボタンを押すたびにKp値が0~10までを繰り返し変化する。
- SET BLACK: 黒い台紙の上にセンサーをおいてから決定を押すことで、そのAD変換値を認識させる。
またリアルタイムでAD変換値をプレビューする機能を追加した。
- SET WHITE: 白線の上にセンサーをおいてから決定を押すことで、そのAD変換値を認識させる。
またリアルタイムでAD変換値をプレビューする機能を追加した。
- SET JUMP: ジャンプモード、すなわち線が途切れた場合に直進、左右旋回のどれを実行するか選択できる。決定ボタンを押すたびにJ->R->L（直進→右旋回→左旋回）が設定される。
- SET STOP: 本体のモーターを動かすか動かさないかを、決定ボタンを押すたびに設定する。無駄な電池消費を避けるため、使っていないときは静止できるようにした。
- ステータス画面: 各状態を表示する画面。モーターのPWM値や白黒検知状態、センサー値、ジャンプモード等が一覧表示される。

# 4. 結果

コース 'n' : 10.96秒
コース '!' : 記録なし
コース 'd' : 記録なし
コース 'e' : 記録なし

残念ながら、原因不明の動作で白線を飛び越す動作ができなかった。
動作不良について検討してみたところ、以下の予想が得られた。

- スタックを多用しすぎたため、コントロールレジスタ等とメモリ空間が衝突した
- コンパイル時に、最適化オプション`-O3`を使用したため、予想外の最適化が行われてしまった
- タクトスイッチの経年劣化で反応が悪くなっていた
- 電池の消費が激しく、モーターを十分に動かす電力がなかった

また、より速く動作させるための案を提案する。

- 電池電圧をAD変換し、容量が少なかったらアラートを出したり、容量によって速度を変えるなどすることで、毎回Kpを変化させる必要がなくなるのではないかと考えた。
- センサーの値を一定のしきい値で白か黒か判断していた。こういった2パターンの方式ではなく、明るさを基準として白線とどれくらい離れているか判断した場合、より機首の調整が早くなると考えた。
- 電池をリチウムイオンなど、残量による電圧低下が少ない二次電池にすることで、安定して充放電、走行ができると考えた。
- 白線に復帰するまでの時間をもとに、PID制御のD制御を行うことを考えた。この場合、白線に復帰する時間が早くなると考えられる。
- 白線から離れていた総時間をもとに、PID制御のI制御を行うことを考えた。この場合、白線に復帰したあとに振動してしまう減少を抑えられると考えられる。
- 計測データをシリアル通信(SCI2)経由でPCへ送信し、それをもとにPID制御の値を決定することを考えた。